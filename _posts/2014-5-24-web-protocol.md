---
layout: post
title: Web会话剖析
category: 协议
---
当在浏览器输入URL时，浏览器首先要找到网站的IP地址，这是通过域名服务(DNS)协议完成的,DNS把名字转换成一个或多个地址并发送回浏览器

###DNS相关：

当访问者第一次访问网站时会发生DNS查找，客户端计算机或本地Internet服务提供商的DNS服务器会保留一份地址副本，防止反复查找

DNS会增加延迟，特别是网站使用了需要从多个地方取数据的混合应用，因为每个新的数据源都会触发其他DNS查询。

如果DNS工作不正常，那么用户就不能访问到网站，除非用户自己输入IP地址，实际上使用IP地址访问的方式也是判断DNS是否有问题的一种方法。

用IP代替URL可能也不起作用，如果一台服务器上放置多个网站，那么服务器需要了解用户正在查找哪个网站，因此，如果用户使用服务器IP地址访问网站而不是主机名，就不可能访问到需要访问的网站。

在一次查找中会涉及多个DNS服务器，当某些地区或服务商的DNS出现问题时，就可能出现有些地方能访问到有些地方访问不到的情况

### 建立连接

有了目标网站的IP地址，浏览器就能用TCP通过Internet建立连接。

TCP用于在两台机器之间传输数据，TCP是建立IP之上的

IP发送数据

IP不保证数据包提交的顺序，甚至不管他们是否到达，所以由TCP负责管理投递顺序、重发和传输速率

TCP也可以对网络连接计时，计算出发送数据包和接收到数据所花费的时间。

###TCP：

TCP在浏览器和服务器之间建立一个端对端的连接

如果丢失数据，TCP会解决这个问题，但是网络会变慢

TCP使用可用带宽的一小部分用于序号，并因为可靠性而牺牲部分效率

TCP通过测量发送数据包和接收到应答的时间差来计算网络延迟

决定唯一TCP会话：客户端和服务器的IP地址和正在使用的端口号

如果要发送敏感数据，希望对数据进行加密。如果从一个安全站点请求页面（前缀是https:）,浏览器和服务器就会使用加密套接字协议层（SSL）对连接进行加密

###SSL：

使消息不能被阅读，用嗅探器或其他在线采集工具难以分析问题

服务器需要做额外的工作来建立连接和加密流量，需要消耗服务器更多的资源

SSL不仅仅加密连接，还可以证明服务器的身份，因为服务器有一个被第三方机构确认的证书

浏览器可能不会缓存任何加密内容，使页面载入时间变慢，同样的对象在不同的页面上都要获取一次

###HTTP

HTTP专注于从服务器请求和获取对象

在获取一个对象之前，浏览器会检查电脑的内存中是否有该对象的备份，如果有，并且备份没有过期，那么浏览器就不会请求她。

GET通过名字请求对象

POST从客户端向服务器发送数据

HEAD要求服务器只发送对象的描述信息，不是对象本身

Ajax应用网站中经常使用PUT和DELETE

浏览器也会向服务器报告他自己，如什么类型的浏览器、是否能接受压缩文档、可以显示什么类型的对象、访问者的语言。服务器可以用这些信息区优化服务器响应。

cookie

以前访问时服务器给浏览器的字符串，服务器通过cookie可以识别出访问者，个性化显示内容。

HTTP状态码

300系列。常用于在服务器和数据中心间平衡负载，或把访问者引导到正确的位置。服务器发送重定向到另一个Web服务器，不会使用200

发送对象前，服务器将会告诉浏览器对象的详细信息

对象的大小、最后修改的时间、内容的类型、发送应答的服务器、是否可缓存、cookie、压缩技术、

装配一个单一对象可能需要Web服务器与其他服务器和数据库进行交互，然后把用户需要的数据组合在一起

###网络延迟：

从服务器把对象放大TCP连接开始，到对象的最后一个字节被收到，一直在计时。大对象发送时间更长，如果发送过程中有数据丢失，或者发送者、接受者相距太远，都会花费更长的时间

大多数大型网站都被放在多个地方，这样做有两个原因：分散负载和减少重大电力中断的影响，拉近计算机和用户的距离，有助于降低网络延迟

全球服务器负载均衡（GSLB）

大型网站可以把访问者送到最近的服务器

内容分发网络（CDN）

在多个地点建立数据

使数据离用户更近，减少在Internet上传输的数据量

尽可能加快必须要穿过Internet的数据传输

用户离数据更近：
控制CDN用户的DNS查找过程，把访问者引导至离服务器数据最近的地方

在网络边界上缓存数据，把一般不变的数据移到离用户更近的地方

边缘包括

加速Internet流量：
选择更好的网络传输路径，更快速的改变路由

调整协议参数优化特定应用，而不是对所有流量都设置一样的参数

使用最新HTTP一次发出多个请求，并对结果进行压缩

使用不同的路径发出冗余数据包，防止偶尔发生的丢包

通过多个运营商、服务提供商避开拥塞点

分割网络边缘的数据流，减少核心数据流量